name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'  # 当推送以 v 开头的标签时触发
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false
        default: 'dev'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            exe_name: VvEnc.exe
            archive_ext: zip
          - os: ubuntu-latest
            exe_name: VvEnc
            archive_ext: tar.gz
          - os: macos-latest
            exe_name: VvEnc
            archive_ext: tar.gz
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: 'x64'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pip install Pillow
      
      - name: Convert icon (if needed) - Windows
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          if ((Test-Path icon.png) -and -not (Test-Path icon.ico)) {
            python convert_icon.py
          }
        continue-on-error: true
      
      - name: Convert icon (if needed) - Linux/macOS
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          if [ -f icon.png ] && [ ! -f icon.ico ]; then
            python convert_icon.py || true
          fi
        continue-on-error: true
      
      - name: Clean old build files - Windows
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          if (Test-Path build) { Remove-Item -Recurse -Force build }
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          if (Test-Path *.spec) { Remove-Item -Force *.spec }
        continue-on-error: true
      
      - name: Clean old build files - Linux/macOS
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          rm -rf build dist *.spec
        continue-on-error: true
      
      - name: Build executable (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $args = @(
            "--name=VvEnc",
            "--onefile",
            "--windowed",
            "--add-data", "core;core",
            "--add-data", "gui;gui",
            "--add-data", "translations;translations",
            "--hidden-import=PyQt5.QtCore",
            "--hidden-import=PyQt5.QtGui",
            "--hidden-import=PyQt5.QtWidgets",
            "--hidden-import=PyQt5.QtMultimedia",
            "--hidden-import=PyQt5.QtWinExtras",
            "--collect-submodules=PyQt5.QtCore",
            "--collect-submodules=PyQt5.QtGui",
            "--collect-submodules=PyQt5.QtWidgets",
            "--collect-submodules=PyQt5.QtMultimedia",
            "--exclude-module=PyQt5.QtWebEngine",
            "--exclude-module=PyQt5.QtWebEngineWidgets",
            "--exclude-module=PyQt5.QtWebEngineCore",
            "--exclude-module=PyQt5.QtBluetooth",
            "--exclude-module=PyQt5.QtNfc",
            "--exclude-module=PyQt5.QtPositioning",
            "--exclude-module=PyQt5.QtLocation",
            "--exclude-module=PyQt5.QtSensors",
            "--exclude-module=PyQt5.QtSerialPort",
            "--exclude-module=PyQt5.QtQuick",
            "--exclude-module=PyQt5.QtQml",
            "--exclude-module=PyQt5.Qt3D",
            "--exclude-module=PyQt5.QtDesigner",
            "--exclude-module=PyQt5.QtHelp",
            "--exclude-module=PyQt5.QtSql",
            "--exclude-module=PyQt5.QtTest",
            "--exclude-module=PyQt5.QtXml",
            "--exclude-module=PyQt5.QtXmlPatterns",
            "--exclude-module=matplotlib",
            "--exclude-module=numpy",
            "--exclude-module=pandas",
            "--exclude-module=scipy",
            "--exclude-module=PIL",
            "--exclude-module=tkinter",
            "--clean",
            "main.py"
          )
          
          if (Test-Path icon.ico) {
            $args = @("--icon=icon.ico") + $args
            $args = $args + @("--add-data", "icon.ico;.")
          }
          
          python -m PyInstaller $args
      
      - name: Build executable (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          ARGS=(
            "--name=VvEnc"
            "--onefile"
            "--add-data" "core:core"
            "--add-data" "gui:gui"
            "--add-data" "translations:translations"
            "--hidden-import=PyQt5.QtCore"
            "--hidden-import=PyQt5.QtGui"
            "--hidden-import=PyQt5.QtWidgets"
            "--hidden-import=PyQt5.QtMultimedia"
            "--collect-submodules=PyQt5.QtCore"
            "--collect-submodules=PyQt5.QtGui"
            "--collect-submodules=PyQt5.QtWidgets"
            "--collect-submodules=PyQt5.QtMultimedia"
            "--exclude-module=PyQt5.QtWebEngine"
            "--exclude-module=PyQt5.QtWebEngineWidgets"
            "--exclude-module=PyQt5.QtWebEngineCore"
            "--exclude-module=PyQt5.QtBluetooth"
            "--exclude-module=PyQt5.QtNfc"
            "--exclude-module=PyQt5.QtPositioning"
            "--exclude-module=PyQt5.QtLocation"
            "--exclude-module=PyQt5.QtSensors"
            "--exclude-module=PyQt5.QtSerialPort"
            "--exclude-module=PyQt5.QtQuick"
            "--exclude-module=PyQt5.QtQml"
            "--exclude-module=PyQt5.Qt3D"
            "--exclude-module=PyQt5.QtDesigner"
            "--exclude-module=PyQt5.QtHelp"
            "--exclude-module=PyQt5.QtSql"
            "--exclude-module=PyQt5.QtTest"
            "--exclude-module=PyQt5.QtXml"
            "--exclude-module=PyQt5.QtXmlPatterns"
            "--exclude-module=matplotlib"
            "--exclude-module=numpy"
            "--exclude-module=pandas"
            "--exclude-module=scipy"
            "--exclude-module=PIL"
            "--exclude-module=tkinter"
            "--strip"
            "--clean"
            "main.py"
          )
          
          if [ -f icon.ico ]; then
            ARGS=("--icon=icon.ico" "${ARGS[@]}")
            ARGS=("${ARGS[@]}" "--add-data" "icon.ico:.")
          fi
          
          python -m PyInstaller "${ARGS[@]}"
      
      - name: Copy additional files
        shell: bash
        run: |
          if [ -f config.json ]; then
            cp config.json dist/
          fi
        continue-on-error: true
      
      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          VERSION=$(echo $VERSION | sed 's/^v//')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create release archive (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $archiveName = "VvEnc-Windows-x64-$env:VERSION.zip"
          Compress-Archive -Path dist\* -DestinationPath $archiveName -Force
          echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
      
      - name: Create release archive (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          OS_NAME=$(echo "${{ matrix.os }}" | sed 's/-latest//' | tr '[:upper:]' '[:lower:]')
          # macOS bash 可能不支持 ${var^}，使用 awk 首字母大写（更兼容）
          OS_NAME_CAPITALIZED=$(echo "$OS_NAME" | awk '{print toupper(substr($0,1,1)) substr($0,2)}')
          ARCHIVE_NAME="VvEnc-${OS_NAME_CAPITALIZED}-x64-${{ env.VERSION }}.tar.gz"
          cd dist
          tar -czf "../$ARCHIVE_NAME" *
          cd ..
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VvEnc-${{ matrix.os }}
          path: |
            dist/${{ matrix.exe_name }}
            ${{ env.ARCHIVE_NAME }}
          retention-days: 30
      
      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.ARCHIVE_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

